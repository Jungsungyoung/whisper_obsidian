<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MeetScribe</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      width: 460px;
      background: #16213e;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    }
    h1 { font-size: 1.6rem; color: #7c83fd; margin-bottom: 4px; }
    .sub { font-size: 0.82rem; color: #666; margin-bottom: 24px; }

    /* drop zone */
    #drop-zone {
      border: 2px dashed #7c83fd44;
      border-radius: 12px;
      padding: 28px;
      text-align: center;
      cursor: pointer;
      transition: border-color .15s, background .15s;
      margin-bottom: 18px;
    }
    #drop-zone.over { border-color: #7c83fd; background: #7c83fd11; }
    #drop-zone .ico { font-size: 2rem; margin-bottom: 6px; }
    #drop-zone .hint { font-size: 0.78rem; color: #555; margin-top: 4px; }
    #fname { font-size: 0.82rem; color: #7c83fd; margin-top: 6px; min-height: 1em; }
    input[type=file] { display: none; }

    /* fields */
    .field { margin-bottom: 14px; }
    label { display: block; font-size: 0.78rem; color: #888; margin-bottom: 5px; }
    input[type=text] {
      width: 100%; padding: 9px 12px;
      background: #0f3460; border: 1px solid #ffffff11; border-radius: 8px;
      color: #e0e0e0; font-size: 0.88rem; outline: none;
      transition: border-color .15s;
    }
    input[type=text]:focus { border-color: #7c83fd; }

    /* button */
    #btn {
      width: 100%; padding: 13px;
      background: #7c83fd; color: #fff; border: none; border-radius: 10px;
      font-size: 0.95rem; font-weight: 600; cursor: pointer;
      transition: background .15s; margin-top: 4px;
    }
    #btn:hover:not(:disabled) { background: #6a71e0; }
    #btn:disabled { background: #333; color: #666; cursor: not-allowed; }

    /* progress */
    #progress { margin-top: 22px; display: none; }
    .step {
      display: flex; align-items: center; gap: 10px;
      padding: 7px 0; font-size: 0.88rem; color: #555;
      border-bottom: 1px solid #ffffff08;
    }
    .step:last-child { border-bottom: none; }
    .step.active { color: #7c83fd; }
    .step.done { color: #4caf50; }
    .step .ico { width: 18px; text-align: center; flex-shrink: 0; }

    /* progress bar */
    #progress-bar-wrap {
      margin-top: 14px; background: #0f3460;
      border-radius: 99px; height: 6px; overflow: hidden;
    }
    #progress-bar {
      height: 100%; width: 0%; background: #7c83fd;
      border-radius: 99px; transition: width 0.4s ease;
    }
    #progress-detail {
      margin-top: 8px; font-size: 0.75rem; color: #666;
      min-height: 1.2em; display: flex; justify-content: space-between;
    }
    #progress-detail .detail-text { color: #7c83fd88; }
    #progress-detail .elapsed-text { color: #444; }

    /* result */
    #result { margin-top: 18px; display: none; }
    .result-box { background: #0f3460; border-radius: 10px; padding: 16px; }
    .result-box p { font-size: 0.82rem; color: #aaa; margin-bottom: 10px; }
    .obs-btn {
      display: block; width: 100%; padding: 10px;
      background: #7c3aed; color: #fff; border: none; border-radius: 8px;
      font-size: 0.88rem; text-align: center; text-decoration: none; cursor: pointer;
      margin-bottom: 8px; transition: background .15s;
    }
    .obs-btn:last-child { margin-bottom: 0; }
    .obs-btn:hover { background: #6d28d9; }

    /* error */
    #err {
      margin-top: 14px; padding: 12px;
      background: #3f0000; border: 1px solid #ff4444; border-radius: 8px;
      font-size: 0.82rem; color: #ff8080; display: none;
    }
  </style>
</head>
<body>
<div class="card">
  <h1>MeetScribe</h1>
  <p class="sub">íšŒì˜ ë…¹ìŒ â†’ ìë™ ì „ì‚¬ â†’ Obsidian ë…¸íŠ¸</p>

  <div id="drop-zone" role="button" tabindex="0" aria-label="íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­"
       onclick="document.getElementById('fi').click()"
       onkeydown="if(event.key==='Enter')document.getElementById('fi').click()">
    <div class="ico">ğŸ™ï¸</div>
    <div>íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
    <div class="hint">mp3 Â· wav Â· m4a Â· mp4</div>
    <div id="fname"></div>
  </div>
  <input type="file" id="fi" accept=".mp3,.wav,.m4a,.mp4,.webm,.ogg">

  <div class="field">
    <label for="title">íšŒì˜ ì œëª©</label>
    <input type="text" id="title" placeholder="ë¹„ì›Œë‘ë©´ íŒŒì¼ëª… ì‚¬ìš©">
  </div>
  <div class="field">
    <label for="project">í”„ë¡œì íŠ¸ (ì„ íƒ)</label>
    <input type="text" id="project" placeholder="ì˜ˆ: [[USV Project Dashboard]]">
  </div>

  <button id="btn" disabled>ë¶„ì„ ì‹œì‘</button>

  <div id="progress">
    <div class="step" id="s-upload"><span class="ico">â¬œ</span>ì—…ë¡œë“œ</div>
    <div class="step" id="s-trans"><span class="ico">â¬œ</span>Whisper ì „ì‚¬</div>
    <div class="step" id="s-ai"><span class="ico">â¬œ</span>Gemini AI ë¶„ì„</div>
    <div class="step" id="s-save"><span class="ico">â¬œ</span>Vault ì €ì¥</div>
    <div id="progress-bar-wrap">
      <div id="progress-bar"></div>
    </div>
    <div id="progress-detail">
      <span class="detail-text" id="detail-text"></span>
      <span class="elapsed-text" id="elapsed-text"></span>
    </div>
  </div>

  <div id="err"></div>

  <div id="result">
    <div class="result-box">
      <p>ì™„ë£Œ! Obsidianì—ì„œ ì—´ê¸°:</p>
      <a id="lnk-meeting" class="obs-btn" href="#">ğŸ“ íšŒì˜ ë…¸íŠ¸ ì—´ê¸°</a>
      <a id="lnk-transcript" class="obs-btn" href="#">ğŸ“„ ì „ì‚¬ ë…¸íŠ¸ ì—´ê¸°</a>
    </div>
  </div>
</div>

<script>
  const dz = document.getElementById('drop-zone');
  const fi = document.getElementById('fi');
  const btn = document.getElementById('btn');
  const fname = document.getElementById('fname');
  let file = null;

  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('over'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('over');
    if (e.dataTransfer.files[0]) setFile(e.dataTransfer.files[0]);
  });
  fi.addEventListener('change', () => { if (fi.files[0]) setFile(fi.files[0]); });

  function setFile(f) {
    file = f;
    fname.textContent = f.name;
    btn.disabled = false;
  }

  btn.addEventListener('click', async () => {
    if (!file) return;
    btn.disabled = true;
    show('progress'); hide('result'); hide('err');
    setStep('s-upload', 'active');

    const fd = new FormData();
    fd.append('file', file);
    fd.append('title', document.getElementById('title').value);
    fd.append('project', document.getElementById('project').value);

    let jobId;
    try {
      const r = await fetch('/upload', { method: 'POST', body: fd });
      const d = await r.json();
      if (!r.ok) throw new Error(d.detail || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
      jobId = d.job_id;
    } catch (e) { return showErr(e.message); }

    setStep('s-upload', 'done');
    poll(jobId);
  });

  function poll(id) {
    const t = setInterval(async () => {
      try {
        const d = await fetch(`/status/${id}`).then(r => r.json());

        // ë‹¨ê³„ í‘œì‹œ
        if (d.status === 'transcribing') {
          setStep('s-trans', 'active');
        } else if (d.status === 'analyzing') {
          setStep('s-trans', 'done'); setStep('s-ai', 'active');
        } else if (d.status === 'building' || d.status === 'saving') {
          setStep('s-ai', 'done'); setStep('s-save', 'active');
        } else if (d.status === 'done') {
          clearInterval(t);
          setStep('s-save', 'done');
          setProgress(100, d.detail || 'ì™„ë£Œ', d.elapsed);
          document.getElementById('lnk-meeting').href = d.result.meeting_uri;
          document.getElementById('lnk-transcript').href = d.result.transcript_uri;
          show('result'); btn.disabled = false;
          return;
        } else if (d.status === 'error') {
          clearInterval(t); showErr(d.error); btn.disabled = false;
          return;
        }

        // í”„ë¡œê·¸ë ˆìŠ¤ ë°” + ìƒì„¸ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        setProgress(d.progress || 0, d.detail || '', d.elapsed || 0);
      } catch (e) { clearInterval(t); showErr(e.message); btn.disabled = false; }
    }, 1500);
  }

  function setProgress(pct, detail, elapsed) {
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('detail-text').textContent = detail;
    document.getElementById('elapsed-text').textContent =
      elapsed > 0 ? `ê²½ê³¼ ${elapsed}ì´ˆ` : '';
  }

  const ICONS = { '': 'â¬œ', active: 'â³', done: 'âœ…' };
  function setStep(id, state) {
    const el = document.getElementById(id);
    el.className = `step ${state}`;
    el.querySelector('.ico').textContent = ICONS[state] ?? 'â¬œ';
  }

  function show(id) { document.getElementById(id).style.display = ''; }
  function hide(id) { document.getElementById(id).style.display = 'none'; }
  function showErr(msg) {
    const el = document.getElementById('err');
    el.textContent = 'ì˜¤ë¥˜: ' + msg;
    el.style.display = '';
    btn.disabled = false;
  }
</script>
</body>
</html>
